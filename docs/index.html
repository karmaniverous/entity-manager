<!DOCTYPE html><html class="default" lang="en" data-base="./"><head><meta charset="utf-8"/><link rel="canonical" href="https://docs.karmanivero.us/entity-manager/"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>@karmaniverous/entity-manager</title><meta name="description" content="Documentation for @karmaniverous/entity-manager"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script defer src="assets/main.js"></script><script async src="assets/icons.js" id="tsd-icons-script"></script><script async src="assets/search.js" id="tsd-search-script"></script><script async src="assets/navigation.js" id="tsd-nav-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="https://github.com/karmaniverous/entity-manager" class="title">@karmaniverous/entity-manager</a><div id="tsd-toolbar-links"></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><h1>@karmaniverous/entity-manager</h1></div><div class="tsd-panel tsd-typography"><h1 id="entity-manager" class="tsd-anchor-link">entity-manager<a href="#entity-manager" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h1><p><a href="https://www.npmjs.com/package/@karmaniverous/entity-manager" target="_blank" class="external"><img src="https://img.shields.io/npm/v/@karmaniverous/entity-manager.svg" alt="npm version"></a> <img src="https://img.shields.io/node/v/@karmaniverous/entity-manager" alt="Node Current">  <a href="https://github.com/karmaniverous/entity-manager/tree/main/LICENSE.md" target="_blank" class="external"><img src="https://img.shields.io/badge/license-BSD--3--Clause-blue.svg" alt="license"></a></p>
<p>EntityManager implements rational indexing &amp; cross-shard querying at scale in your NoSQL database so you can focus on your application logic.</p>
<p>If you have any questions, please <a href="https://github.com/karmaniverous/entity-manager/discussions" target="_blank" class="external">start a discussion</a>. Otherwise stay tuned!</p>
<h2 id="what-is-this" class="tsd-anchor-link">What is this?<a href="#what-is-this" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Entity Manager is a TypeScript-first library that applies a provider‑agnostic, highly opinionated single‑table design to your NoSQL data. It lets you:</p>
<ul>
<li>Define a global hash key and range key, plus additional generated properties used by your indexes.</li>
<li>Encode/decode indexable elements via transcodes so strings sort like their original types.</li>
<li>Configure a time‑based sharding strategy (shard bumps) that grows as you scale.</li>
<li>Query across many shards and indexes in parallel through injected “shard query” functions — results are combined, de‑duplicated, sorted, and returned with a compact, dehydrated page key for the next request.</li>
</ul>
<p>It is designed to work with stores like DynamoDB but keeps the orchestration provider‑neutral.</p>
<p>Key links:</p>
<ul>
<li>API: <a href="https://docs.karmanivero.us/entity-manager">https://docs.karmanivero.us/entity-manager</a></li>
<li>Requirements: see .stan/system/stan.requirements.md (authoritative for v6.14.0)</li>
<li>Example test configuration: see test/config.ts</li>
</ul>
<h2 id="features" class="tsd-anchor-link">Features<a href="#features" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>Global model for generated properties, indexes, and property transcodes
<ul>
<li>generatedProperties.sharded and generatedProperties.unsharded</li>
<li>Global indexes: indexToken → { hashKey, rangeKey, projections? }</li>
<li>Global propertyTranscodes: property → transcodeName</li>
</ul>
</li>
<li>Deterministic sharding
<ul>
<li>Time‑windowed shard bumps: { timestamp, charBits, chars }</li>
<li>Full shard space assignment per bump (uses radix**chars placeholders)</li>
<li>Cross‑bump query enumeration over all applicable shards</li>
</ul>
</li>
<li>Page key dehydration/rehydration
<ul>
<li>Compact string arrays and lz‑string compression for transport</li>
<li>Rehydrate back to pageKey objects for each index+shard</li>
</ul>
</li>
<li>Provider‑agnostic parallel query orchestration
<ul>
<li>Inject shard query functions for each index</li>
<li>Parallel fan‑out with configurable throttle</li>
<li>Combine, dedupe by unique property, and sort results</li>
</ul>
</li>
<li>Strong typing + runtime validation
<ul>
<li>Zod‑validated config parsing</li>
<li>Robust TypeScript surface for config, items, keys, queries</li>
</ul>
</li>
</ul>
<h2 id="install" class="tsd-anchor-link">Install<a href="#install" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><pre><code class="bash"><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">install</span><span class="hl-1"> </span><span class="hl-2">@karmaniverous/entity-manager</span><br/><span class="hl-3"># optional: testing support used in the repo</span><br/><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">install</span><span class="hl-1"> </span><span class="hl-4">--save-dev</span><span class="hl-1"> </span><span class="hl-2">@karmaniverous/mock-db</span>
</code><button type="button">Copy</button></pre>

<p>TypeScript is strongly recommended. The library will validate configuration at runtime for JavaScript users, but you lose compile‑time guarantees.</p>
<h2 id="usage-overview" class="tsd-anchor-link">Usage overview<a href="#usage-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The pattern has three parts:</p>
<ol>
<li>Define your entity types and a config map</li>
</ol>
<ul>
<li>Each entity type lists all properties that exist on your records.</li>
<li>Entity‑level behaviors live in the config’s entities block (timestamp property, unique property, shard bumps).</li>
<li>Generated properties, indexes, and transcodes are defined globally.</li>
</ul>
<ol start="2">
<li>Create an EntityManager instance</li>
</ol>
<ul>
<li>Pass your config (validated with Zod).</li>
<li>Optionally inject a logger with debug/error methods (defaults to console).</li>
</ul>
<ol start="3">
<li>Use EntityManager helpers</li>
</ol>
<ul>
<li>addKeys / getPrimaryKey / removeKeys</li>
<li>encodeGeneratedProperty / decodeGeneratedProperty</li>
<li>getIndexComponents / unwrapIndex / dehydrateIndexItem / rehydrateIndexItem</li>
<li>dehydratePageKeyMap / rehydratePageKeyMap</li>
<li>query(options) to orchestrate cross‑shard multi‑index queries</li>
</ul>
<h2 id="quick-start-typescript" class="tsd-anchor-link">Quick start (TypeScript)<a href="#quick-start-typescript" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Below is a minimal end‑to‑end example showing shape and intent. It mirrors the current implementation’s global config model.</p>
<pre><code class="ts"><span class="hl-5">import</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">defaultTranscodes</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">type</span><span class="hl-1"> </span><span class="hl-6">ConfigMap</span><span class="hl-1">,</span><br/><span class="hl-1">} </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-manager&#39;</span><span class="hl-1">;</span><br/><span class="hl-5">import</span><span class="hl-1"> { </span><span class="hl-6">EntityManager</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-manager&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// 1) Entity definitions (Typescript types)</span><br/><span class="hl-4">interface</span><span class="hl-1"> </span><span class="hl-7">User</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">userId</span><span class="hl-1">: </span><span class="hl-7">string</span><span class="hl-1">; </span><span class="hl-3">// unique property</span><br/><span class="hl-1">  </span><span class="hl-6">created</span><span class="hl-1">: </span><span class="hl-7">number</span><span class="hl-1">; </span><span class="hl-3">// timestamp property</span><br/><span class="hl-1">  </span><span class="hl-6">updated</span><span class="hl-1">: </span><span class="hl-7">number</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-6">firstNameCanonical</span><span class="hl-1">: </span><span class="hl-7">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-6">lastNameCanonical</span><span class="hl-1">: </span><span class="hl-7">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-3">// Generated properties exist on stored items but are configured globally:</span><br/><span class="hl-1">  </span><span class="hl-3">// e.g., firstNameRK (unsharded), lastNameRK (unsharded), userPK (sharded)</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-7">MyConfigMap</span><span class="hl-1"> = </span><span class="hl-7">ConfigMap</span><span class="hl-1">&lt;{</span><br/><span class="hl-1">  </span><span class="hl-6">EntityMap</span><span class="hl-1">: { </span><span class="hl-6">user</span><span class="hl-1">: </span><span class="hl-7">User</span><span class="hl-1"> };</span><br/><span class="hl-1">  </span><span class="hl-6">HashKey</span><span class="hl-1">: </span><span class="hl-2">&#39;hashKey&#39;</span><span class="hl-1">; </span><span class="hl-3">// defaults are &#39;hashKey&#39; / &#39;rangeKey&#39; if omitted</span><br/><span class="hl-1">  </span><span class="hl-6">RangeKey</span><span class="hl-1">: </span><span class="hl-2">&#39;rangeKey&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-6">ShardedKeys</span><span class="hl-1">: </span><span class="hl-2">&#39;userPK&#39;</span><span class="hl-1">; </span><span class="hl-3">// token(s) for sharded generated properties</span><br/><span class="hl-1">  </span><span class="hl-6">UnshardedKeys</span><span class="hl-1">: </span><span class="hl-2">&#39;firstNameRK&#39;</span><span class="hl-1"> | </span><span class="hl-2">&#39;lastNameRK&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-6">TranscodedProperties</span><span class="hl-1">:</span><br/><span class="hl-1">    | </span><span class="hl-2">&#39;userId&#39;</span><br/><span class="hl-1">    | </span><span class="hl-2">&#39;created&#39;</span><br/><span class="hl-1">    | </span><span class="hl-2">&#39;updated&#39;</span><br/><span class="hl-1">    | </span><span class="hl-2">&#39;firstNameCanonical&#39;</span><br/><span class="hl-1">    | </span><span class="hl-2">&#39;lastNameCanonical&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">}&gt;;</span><br/><br/><span class="hl-3">// 2) Build a config with the global model</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-8">now</span><span class="hl-1"> = </span><span class="hl-6">Date</span><span class="hl-1">.</span><span class="hl-0">now</span><span class="hl-1">();</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-8">manager</span><span class="hl-1"> = </span><span class="hl-4">new</span><span class="hl-1"> </span><span class="hl-0">EntityManager</span><span class="hl-1">&lt;</span><span class="hl-7">MyConfigMap</span><span class="hl-1">&gt;({</span><br/><span class="hl-1">  </span><span class="hl-3">// Per-entity: unique + timestamp + shard schedule (+ optional defaults)</span><br/><span class="hl-1">  </span><span class="hl-6">entities:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">user:</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-6">uniqueProperty:</span><span class="hl-1"> </span><span class="hl-2">&#39;userId&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-6">timestampProperty:</span><span class="hl-1"> </span><span class="hl-2">&#39;created&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-6">shardBumps:</span><span class="hl-1"> [</span><br/><span class="hl-1">        </span><span class="hl-3">// records with timestamp &lt; now → effectively unsharded</span><br/><span class="hl-1">        { </span><span class="hl-6">timestamp:</span><span class="hl-1"> </span><span class="hl-6">now</span><span class="hl-1">, </span><span class="hl-6">charBits:</span><span class="hl-1"> </span><span class="hl-9">1</span><span class="hl-1">, </span><span class="hl-6">chars:</span><span class="hl-1"> </span><span class="hl-9">0</span><span class="hl-1"> },</span><br/><span class="hl-1">        </span><span class="hl-3">// records with timestamp ≥ now → 1 char at radix 4 (2^2) gives 4 shards</span><br/><span class="hl-1">        { </span><span class="hl-6">timestamp:</span><span class="hl-1"> </span><span class="hl-6">now</span><span class="hl-1">, </span><span class="hl-6">charBits:</span><span class="hl-1"> </span><span class="hl-9">2</span><span class="hl-1">, </span><span class="hl-6">chars:</span><span class="hl-1"> </span><span class="hl-9">1</span><span class="hl-1"> },</span><br/><span class="hl-1">      ],</span><br/><span class="hl-1">      </span><span class="hl-3">// optional defaults (used by query if omitted in options)</span><br/><span class="hl-1">      </span><span class="hl-6">defaultLimit:</span><span class="hl-1"> </span><span class="hl-9">10</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-6">defaultPageSize:</span><span class="hl-1"> </span><span class="hl-9">10</span><span class="hl-1">,</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  },</span><br/><br/><span class="hl-1">  </span><span class="hl-3">// Global generated properties (tokens → element lists)</span><br/><span class="hl-1">  </span><span class="hl-6">generatedProperties:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">sharded:</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-6">userPK:</span><span class="hl-1"> [</span><span class="hl-2">&#39;userId&#39;</span><span class="hl-1">], </span><span class="hl-3">// atomic (all required)</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-6">unsharded:</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-6">firstNameRK:</span><span class="hl-1"> [</span><span class="hl-2">&#39;firstNameCanonical&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;lastNameCanonical&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;created&#39;</span><span class="hl-1">],</span><br/><span class="hl-1">      </span><span class="hl-6">lastNameRK:</span><span class="hl-1"> [</span><span class="hl-2">&#39;lastNameCanonical&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;firstNameCanonical&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;created&#39;</span><span class="hl-1">],</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  },</span><br/><br/><span class="hl-1">  </span><span class="hl-3">// Global key tokens</span><br/><span class="hl-1">  </span><span class="hl-6">hashKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;hashKey&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">rangeKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;rangeKey&#39;</span><span class="hl-1">,</span><br/><br/><span class="hl-1">  </span><span class="hl-3">// Global indexes (hashKey, rangeKey must match allowed token sets)</span><br/><span class="hl-1">  </span><span class="hl-6">indexes:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">created:</span><span class="hl-1"> { </span><span class="hl-6">hashKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;hashKey&#39;</span><span class="hl-1">, </span><span class="hl-6">rangeKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;created&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">    </span><span class="hl-6">updated:</span><span class="hl-1"> { </span><span class="hl-6">hashKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;hashKey&#39;</span><span class="hl-1">, </span><span class="hl-6">rangeKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;updated&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">    </span><span class="hl-6">firstName:</span><span class="hl-1"> { </span><span class="hl-6">hashKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;hashKey&#39;</span><span class="hl-1">, </span><span class="hl-6">rangeKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;firstNameRK&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">    </span><span class="hl-6">lastName:</span><span class="hl-1"> { </span><span class="hl-6">hashKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;hashKey&#39;</span><span class="hl-1">, </span><span class="hl-6">rangeKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;lastNameRK&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">    </span><span class="hl-6">userCreated:</span><span class="hl-1"> { </span><span class="hl-6">hashKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;userPK&#39;</span><span class="hl-1">, </span><span class="hl-6">rangeKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;created&#39;</span><span class="hl-1"> }, </span><span class="hl-3">// sharded alt hash</span><br/><span class="hl-1">  },</span><br/><br/><span class="hl-1">  </span><span class="hl-3">// Transcode mapping for scalar/unsharded elements and properties</span><br/><span class="hl-1">  </span><span class="hl-6">propertyTranscodes:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">userId:</span><span class="hl-1"> </span><span class="hl-2">&#39;string&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">created:</span><span class="hl-1"> </span><span class="hl-2">&#39;timestamp&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">updated:</span><span class="hl-1"> </span><span class="hl-2">&#39;timestamp&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">firstNameCanonical:</span><span class="hl-1"> </span><span class="hl-2">&#39;string&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">lastNameCanonical:</span><span class="hl-1"> </span><span class="hl-2">&#39;string&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  },</span><br/><br/><span class="hl-1">  </span><span class="hl-3">// Transcodes (can override/extend defaultTranscodes)</span><br/><span class="hl-1">  </span><span class="hl-6">transcodes:</span><span class="hl-1"> </span><span class="hl-6">defaultTranscodes</span><span class="hl-1">,</span><br/><br/><span class="hl-1">  </span><span class="hl-3">// Delimiters and query throttle (defaults shown)</span><br/><span class="hl-1">  </span><span class="hl-6">generatedKeyDelimiter:</span><span class="hl-1"> </span><span class="hl-2">&#39;|&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">generatedValueDelimiter:</span><span class="hl-1"> </span><span class="hl-2">&#39;#&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">shardKeyDelimiter:</span><span class="hl-1"> </span><span class="hl-2">&#39;!&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">throttle:</span><span class="hl-1"> </span><span class="hl-9">10</span><span class="hl-1">,</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<h3 id="generate-keys-on-items" class="tsd-anchor-link">Generate keys on items<a href="#generate-keys-on-items" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="ts"><span class="hl-3">// A partial item (no keys yet)</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-8">user</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-6">userId:</span><span class="hl-1"> </span><span class="hl-2">&#39;u123&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">created:</span><span class="hl-1"> </span><span class="hl-6">Date</span><span class="hl-1">.</span><span class="hl-0">now</span><span class="hl-1">(),</span><br/><span class="hl-1">  </span><span class="hl-6">updated:</span><span class="hl-1"> </span><span class="hl-6">Date</span><span class="hl-1">.</span><span class="hl-0">now</span><span class="hl-1">(),</span><br/><span class="hl-1">  </span><span class="hl-6">firstNameCanonical:</span><span class="hl-1"> </span><span class="hl-2">&#39;lee&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">lastNameCanonical:</span><span class="hl-1"> </span><span class="hl-2">&#39;zhang&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-3">// Add hashKey, rangeKey, and generated properties</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-8">record</span><span class="hl-1"> = </span><span class="hl-6">manager</span><span class="hl-1">.</span><span class="hl-0">addKeys</span><span class="hl-1">(</span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">, </span><span class="hl-6">user</span><span class="hl-1">); </span><span class="hl-3">// returns EntityRecord&lt;...&gt;</span><br/><br/><span class="hl-3">// Get just the primary key</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-8">keyOnly</span><span class="hl-1"> = </span><span class="hl-6">manager</span><span class="hl-1">.</span><span class="hl-0">getPrimaryKey</span><span class="hl-1">(</span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">, </span><span class="hl-6">user</span><span class="hl-1">); </span><span class="hl-3">// { hashKey, rangeKey }</span><br/><br/><span class="hl-3">// Remove generated keys from a stored record</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-8">pruned</span><span class="hl-1"> = </span><span class="hl-6">manager</span><span class="hl-1">.</span><span class="hl-0">removeKeys</span><span class="hl-1">(</span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">, </span><span class="hl-6">record</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<h3 id="encodedecode-generated-property-strings" class="tsd-anchor-link">Encode/decode generated property strings<a href="#encodedecode-generated-property-strings" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="ts"><span class="hl-3">// Encode an unsharded generated property (always returns a string)</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-8">fn</span><span class="hl-1"> = </span><span class="hl-6">manager</span><span class="hl-1">.</span><span class="hl-0">encodeGeneratedProperty</span><span class="hl-1">(</span><span class="hl-2">&#39;firstNameRK&#39;</span><span class="hl-1">, </span><span class="hl-6">record</span><span class="hl-1">);</span><br/><span class="hl-3">// e.g. &quot;firstNameCanonical#lee|lastNameCanonical#zhang|created#000001711234567&quot;</span><br/><br/><span class="hl-3">// Decode back into an object fragment</span><br/><span class="hl-5">import</span><span class="hl-1"> { </span><span class="hl-6">decodeGeneratedProperty</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-manager&#39;</span><span class="hl-1">;</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-8">decoded</span><span class="hl-1"> = </span><span class="hl-0">decodeGeneratedProperty</span><span class="hl-1">(</span><span class="hl-6">manager</span><span class="hl-1">, </span><span class="hl-6">fn</span><span class="hl-1">); </span><span class="hl-3">// { firstNameCanonical: &#39;lee&#39;, ... }</span>
</code><button type="button">Copy</button></pre>

<h3 id="query-across-shards-and-indexes" class="tsd-anchor-link">Query across shards and indexes<a href="#query-across-shards-and-indexes" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Entity Manager relies on injected shard query functions to perform provider‑specific queries on each shard/index page. The library orchestrates:</p>
<ul>
<li>page‑key rehydration → parallel shard queries → de‑duplication and sorting → page‑key dehydration.</li>
</ul>
<pre><code class="ts"><span class="hl-5">import</span><span class="hl-1"> </span><span class="hl-5">type</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">QueryOptions</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">ShardQueryFunction</span><span class="hl-1">,</span><br/><span class="hl-1">} </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-manager&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// Example shard query using a made-up client (see @karmaniverous/mock-db in repo tests)</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-0">firstNameQuery</span><span class="hl-1">: </span><span class="hl-7">ShardQueryFunction</span><span class="hl-1">&lt;</span><span class="hl-7">MyConfigMap</span><span class="hl-1">&gt; = </span><span class="hl-4">async</span><span class="hl-1"> (</span><br/><span class="hl-1">  </span><span class="hl-6">hashKey</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">pageKey</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">pageSize</span><span class="hl-1">,</span><br/><span class="hl-1">) </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-3">// Return { count, items, pageKey? } for this shard+index page</span><br/><span class="hl-1">  </span><span class="hl-3">// pageKey is a partial item object with necessary index components</span><br/><span class="hl-1">  </span><span class="hl-3">// ... perform provider-specific work here ...</span><br/><span class="hl-1">  </span><span class="hl-5">return</span><span class="hl-1"> { </span><span class="hl-6">count:</span><span class="hl-1"> </span><span class="hl-9">0</span><span class="hl-1">, </span><span class="hl-6">items:</span><span class="hl-1"> [], </span><span class="hl-6">pageKey</span><span class="hl-1"> };</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-3">// Invoke query with shardQueryMap</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-8">result</span><span class="hl-1"> = </span><span class="hl-5">await</span><span class="hl-1"> </span><span class="hl-6">manager</span><span class="hl-1">.</span><span class="hl-0">query</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-6">entityToken:</span><span class="hl-1"> </span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">item:</span><span class="hl-1"> {}, </span><span class="hl-3">// often used to supply elements for alternate hash keys</span><br/><span class="hl-1">  </span><span class="hl-6">shardQueryMap:</span><span class="hl-1"> { </span><span class="hl-6">firstName:</span><span class="hl-1"> </span><span class="hl-6">firstNameQuery</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-6">limit:</span><span class="hl-1"> </span><span class="hl-9">50</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">pageSize:</span><span class="hl-1"> </span><span class="hl-9">10</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-3">// optional: pageKeyMap: previousResult.pageKeyMap,</span><br/><span class="hl-1">  </span><span class="hl-3">// optional: timestampFrom / timestampTo for shard-space windowing</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>Notes:</p>
<ul>
<li>The result includes a compressed pageKeyMap string for the next call.</li>
<li>Entity Manager enumerates the hash key space for the time window, rehydrates the prior page keys (if any), and fans out queries across all shard+index pairs in <code>shardQueryMap</code> (up to <code>throttle</code>).</li>
<li>Items are deduplicated by the entity’s unique property and sorted by <code>sortOrder</code> (if provided).</li>
</ul>
<h2 id="configuration-reference-current-model-v6140" class="tsd-anchor-link">Configuration reference (current model, v6.14.0)<a href="#configuration-reference-current-model-v6140" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>entities: Record&lt;entityToken, { timestampProperty, uniqueProperty, shardBumps?, defaultLimit?, defaultPageSize? }&gt;</li>
<li>generatedProperties:
<ul>
<li>sharded: Record&lt;ShardedKey, TranscodedProperties[]&gt;</li>
<li>unsharded: Record&lt;UnshardedKey, TranscodedProperties[]&gt;</li>
</ul>
</li>
<li>indexes: Record&lt;indexToken, {
<ul>
<li>hashKey: HashKey | ShardedKey</li>
<li>rangeKey: RangeKey | UnshardedKey | TranscodedProperties</li>
<li>projections?: string[]
}&gt;</li>
</ul>
</li>
<li>propertyTranscodes: Record&lt;TranscodedProperties, keyof TranscodeMap&gt;</li>
<li>transcodes: Record&lt;transcodeName, { encode, decode }&gt; (defaults to defaultTranscodes)</li>
<li>hashKey: HashKey (e.g., 'hashKey')</li>
<li>rangeKey: RangeKey (e.g., 'rangeKey')</li>
<li>generatedKeyDelimiter: string (default '|', must match /\W+/)</li>
<li>generatedValueDelimiter: string (default '#', must match /\W+/)</li>
<li>shardKeyDelimiter: string (default '!', must match /\W+/)</li>
<li>throttle: number (default 10)</li>
</ul>
<p>Validation highlights:</p>
<ul>
<li>Delimiters must not contain each other.</li>
<li>Keys and tokens must be mutually exclusive as required.</li>
<li>Generated property element lists are non‑empty and have no duplicates.</li>
<li>propertyTranscodes values must exist in transcodes.</li>
<li>Index hashKey/rangeKey must use valid token sets.</li>
<li>shardBumps are sorted, include a zero‑timestamp bump if missing, and chars must increase monotonically with timestamp.</li>
</ul>
<p>Sharding:</p>
<ul>
<li>For assignment: a record always uses all placeholders for its applicable bump; suffix space is (2**charBits) ** chars.</li>
<li>For queries: hash key space spans all bumps overlapping [timestampFrom, timestampTo].</li>
</ul>
<h2 id="esm-cjs" class="tsd-anchor-link">ESM / CJS<a href="#esm-cjs" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><pre><code class="ts"><span class="hl-3">// ESM</span><br/><span class="hl-5">import</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">EntityManager</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">defaultTranscodes</span><span class="hl-1">,</span><br/><span class="hl-1">} </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-manager&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// CJS</span><br/><span class="hl-4">const</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-8">EntityManager</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-8">defaultTranscodes</span><span class="hl-1">,</span><br/><span class="hl-1">} = </span><span class="hl-0">require</span><span class="hl-1">(</span><span class="hl-2">&#39;@karmaniverous/entity-manager&#39;</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<h2 id="logging" class="tsd-anchor-link">Logging<a href="#logging" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>All helpers log debug context and error detail via the injected logger (defaults to <code>console</code>). In tests, you may supply a quiet logger:</p>
<pre><code class="ts"><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-8">logger</span><span class="hl-1"> = { </span><span class="hl-0">debug</span><span class="hl-6">:</span><span class="hl-1"> () </span><span class="hl-4">=&gt;</span><span class="hl-1"> </span><span class="hl-4">undefined</span><span class="hl-1">, </span><span class="hl-6">error:</span><span class="hl-1"> </span><span class="hl-6">console</span><span class="hl-1">.</span><span class="hl-6">error</span><span class="hl-1"> };</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-8">manager</span><span class="hl-1"> = </span><span class="hl-4">new</span><span class="hl-1"> </span><span class="hl-0">EntityManager</span><span class="hl-1">(</span><span class="hl-6">config</span><span class="hl-1">, </span><span class="hl-6">logger</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<h2 id="delimiter-safety" class="tsd-anchor-link">Delimiter safety<a href="#delimiter-safety" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Generated key/value delimiters and the shard key delimiter are used when composing strings:</p>
<ul>
<li>generatedKeyDelimiter: '|' (between pairs)</li>
<li>generatedValueDelimiter: '#' (between key and value)</li>
<li>shardKeyDelimiter: '!' (between entity token and shard suffix)</li>
</ul>
<p>Your scalar property values used in generated properties should not include these delimiters. If they must, set custom delimiters (must match /\W+/ and not contain each other).</p>
<h2 id="types-youll-use-most" class="tsd-anchor-link">Types you’ll use most<a href="#types-youll-use-most" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>ConfigMap<M></li>
<li>EntityItem<C>, EntityRecord<C>, EntityKey<C>, EntityToken<C></li>
<li>QueryOptions<C>, QueryResult<C></li>
<li>PageKey<C>, PageKeyMap<C></li>
<li>ShardQueryFunction<C>, ShardQueryMap<C>, ShardBump</li>
</ul>
<p>See the full API: <a href="https://docs.karmanivero.us/entity-manager">https://docs.karmanivero.us/entity-manager</a></p>
<h2 id="scripts-repo" class="tsd-anchor-link">Scripts (repo)<a href="#scripts-repo" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>build: rollup outputs ESM/CJS + .d.ts</li>
<li>test: vitest with coverage</li>
<li>lint: ESLint (type‑aware) + Prettier integration</li>
<li>docs: TypeDoc (links to external type docs for shared utility packages)</li>
<li>typecheck: tsc + tsd (type‑level tests)</li>
</ul>
<h2 id="license" class="tsd-anchor-link">License<a href="#license" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>BSD‑3‑Clause (see package.json).</p>
<hr>
<p>Built for you with ❤️ on Bali! Find more great tools &amp; templates on <a href="https://github.com/karmaniverous" target="_blank" class="external">my GitHub Profile</a>.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#entity-manager"><span>entity-<wbr/>manager</span></a><ul><li><a href="#what-is-this"><span>What is this?</span></a></li><li><a href="#features"><span>Features</span></a></li><li><a href="#install"><span>Install</span></a></li><li><a href="#usage-overview"><span>Usage overview</span></a></li><li><a href="#quick-start-typescript"><span>Quick start (<wbr/>Type<wbr/>Script)</span></a></li><li><ul><li><a href="#generate-keys-on-items"><span>Generate keys on items</span></a></li><li><a href="#encodedecode-generated-property-strings"><span>Encode/decode generated property strings</span></a></li><li><a href="#query-across-shards-and-indexes"><span>Query across shards and indexes</span></a></li></ul></li><li><a href="#configuration-reference-current-model-v6140"><span>Configuration reference (current model, v6.14.0)</span></a></li><li><a href="#esm-cjs"><span>ESM / <wbr/>CJS</span></a></li><li><a href="#logging"><span>Logging</span></a></li><li><a href="#delimiter-safety"><span>Delimiter safety</span></a></li><li><a href="#types-youll-use-most"><span>Types you’ll use most</span></a></li><li><a href="#scripts-repo"><span>Scripts (repo)</span></a></li><li><a href="#license"><span>License</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="modules.html">@karmaniverous/entity-manager</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
