<!DOCTYPE html><html class="default" lang="en" data-base="./"><head><meta charset="utf-8"/><link rel="canonical" href="https://docs.karmanivero.us/entity-manager/"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>@karmaniverous/entity-manager</title><meta name="description" content="Documentation for @karmaniverous/entity-manager"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script defer src="assets/main.js"></script><script async src="assets/icons.js" id="tsd-icons-script"></script><script async src="assets/search.js" id="tsd-search-script"></script><script async src="assets/navigation.js" id="tsd-nav-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="https://github.com/karmaniverous/entity-manager" class="title">@karmaniverous/entity-manager</a><div id="tsd-toolbar-links"></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><h1>@karmaniverous/entity-manager</h1></div><div class="tsd-panel tsd-typography"><h1 id="entity-manager" class="tsd-anchor-link">entity-manager<a href="#entity-manager" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h1><p><a href="https://www.npmjs.com/package/@karmaniverous/entity-manager" target="_blank" class="external"><img src="https://img.shields.io/npm/v/@karmaniverous/entity-manager.svg" alt="npm version"></a> <img src="https://img.shields.io/node/v/@karmaniverous/entity-manager" alt="Node Current">  <a href="https://github.com/karmaniverous/entity-manager/tree/main/LICENSE.md" target="_blank" class="external"><img src="https://img.shields.io/badge/license-BSD--3--Clause-blue.svg" alt="license"></a></p>
<p>Entity Manager implements rational indexing &amp; cross‑shard querying at scale in your NoSQL database so you can focus on application logic. It is provider‑agnostic (great fit for DynamoDB) and TypeScript‑first with strong types and runtime validation.</p>
<p>Key links:</p>
<ul>
<li>Docs: <a href="https://docs.karmanivero.us/entity-manager">https://docs.karmanivero.us/entity-manager</a></li>
<li>Discussions: <a href="https://github.com/karmaniverous/entity-manager/discussions" target="_blank" class="external">https://github.com/karmaniverous/entity-manager/discussions</a></li>
</ul>
<h2 id="why-this-library" class="tsd-anchor-link">Why this library?<a href="#why-this-library" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Modern NoSQL puts the burden of indexing, sharding, and pagination on the application. Entity Manager gives you:</p>
<ul>
<li>Values‑first configuration with runtime validation (Zod) and best‑in‑class inference.</li>
<li>Token‑aware and index‑aware types end‑to‑end (entities, keys, page keys, queries).</li>
<li>Deterministic sharding with a time‑based scale‑up schedule.</li>
<li>Cross‑shard, multi‑index query orchestration with dedupe and sorting.</li>
<li>Dehydration/rehydration of page keys to pass a single compact token between calls.</li>
</ul>
<h2 id="install" class="tsd-anchor-link">Install<a href="#install" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><pre><code class="bash"><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">install</span><span class="hl-1"> </span><span class="hl-2">@karmaniverous/entity-manager</span><br/><span class="hl-3"># optional (tests/demo helpers)</span><br/><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">install</span><span class="hl-1"> </span><span class="hl-4">--save-dev</span><span class="hl-1"> </span><span class="hl-2">@karmaniverous/mock-db</span>
</code><button type="button">Copy</button></pre>

<h2 id="dx-highlights" class="tsd-anchor-link">DX highlights<a href="#dx-highlights" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>Values‑first + schema‑first config:
<ul>
<li>Use a config literal (prefer <code>as const</code> and <code>satisfies</code>) to preserve literal tokens.</li>
<li>Optionally provide Zod schemas (<code>entitiesSchema</code>) to infer entity shapes without generics.</li>
</ul>
</li>
<li>Projection‑aware typing (type‑only K):
<ul>
<li>Pass attributes as a const tuple (K) through your query types to narrow result items to Pick&lt;…&gt; of those properties.</li>
<li>No runtime change; adapters execute projections. Adapters should auto‑include <code>uniqueProperty</code> and any explicit sort keys when callers omit them to preserve dedupe/sort invariants.</li>
</ul>
</li>
<li>Index‑aware typing (CF/CC helpers):
<ul>
<li>CF: drive index token unions and page‑key narrowing directly from a values‑first config literal (<code>QueryOptionsByCF</code>, <code>ShardQueryMapByCF</code>).</li>
<li>CC: derive index tokens from a captured config type while reusing CF for narrowing (<code>QueryOptionsByCC</code>, <code>ShardQueryMapByCC</code>).</li>
</ul>
</li>
<li>Token‑aware helpers:
<ul>
<li><code>addKeys</code>, <code>getPrimaryKey</code>, <code>removeKeys</code> narrow types by entity token (no casts).</li>
</ul>
</li>
<li>Index‑aware page keys (optional CF channel):
<ul>
<li>Provide a values‑first config literal (CF) with <code>indexes</code> and get typed page keys per index.</li>
<li>Use <code>QueryOptionsByCF</code> and <code>ShardQueryMapByCF</code> to derive index token unions directly from CF.</li>
</ul>
</li>
<li>CC-based DX sugar (values-first captured config):
<ul>
<li>Use <code>QueryOptionsByCC</code> and <code>ShardQueryMapByCC</code> to derive index token unions from a captured config type (via <code>IndexTokensFrom</code>), while still benefiting from page-key narrowing.</li>
</ul>
</li>
</ul>
<h2 id="quick-start-valuesfirst-schemafirst" class="tsd-anchor-link">Quick start (values‑first + schema‑first)<a href="#quick-start-valuesfirst-schemafirst" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><pre><code class="ts"><span class="hl-5">import</span><span class="hl-1"> { </span><span class="hl-6">z</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;zod&#39;</span><span class="hl-1">;</span><br/><span class="hl-5">import</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">createEntityManager</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">defaultTranscodes</span><span class="hl-1">,</span><br/><span class="hl-1">} </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-manager&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// 1) Schema-first entity shapes (non-generated fields only)</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">userSchema</span><span class="hl-1"> = </span><span class="hl-6">z</span><span class="hl-1">.</span><span class="hl-0">object</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-6">userId:</span><span class="hl-1"> </span><span class="hl-6">z</span><span class="hl-1">.</span><span class="hl-0">string</span><span class="hl-1">(), </span><span class="hl-3">// unique property</span><br/><span class="hl-1">  </span><span class="hl-6">created:</span><span class="hl-1"> </span><span class="hl-6">z</span><span class="hl-1">.</span><span class="hl-0">number</span><span class="hl-1">(), </span><span class="hl-3">// timestamp property</span><br/><span class="hl-1">  </span><span class="hl-6">updated:</span><span class="hl-1"> </span><span class="hl-6">z</span><span class="hl-1">.</span><span class="hl-0">number</span><span class="hl-1">().</span><span class="hl-0">optional</span><span class="hl-1">(),</span><br/><span class="hl-1">  </span><span class="hl-6">firstNameCanonical:</span><span class="hl-1"> </span><span class="hl-6">z</span><span class="hl-1">.</span><span class="hl-0">string</span><span class="hl-1">(),</span><br/><span class="hl-1">  </span><span class="hl-6">lastNameCanonical:</span><span class="hl-1"> </span><span class="hl-6">z</span><span class="hl-1">.</span><span class="hl-0">string</span><span class="hl-1">(),</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-3">// 2) Values-first config literal (prefer `as const`)</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">config</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-6">hashKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;hashKey2&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">rangeKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;rangeKey&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">generatedProperties:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">sharded:</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-6">userPK:</span><span class="hl-1"> [</span><span class="hl-2">&#39;userId&#39;</span><span class="hl-1">] </span><span class="hl-5">as</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1">,</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-6">unsharded:</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-6">firstNameRK:</span><span class="hl-1"> [</span><span class="hl-2">&#39;firstNameCanonical&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;lastNameCanonical&#39;</span><span class="hl-1">] </span><span class="hl-5">as</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-6">lastNameRK:</span><span class="hl-1"> [</span><span class="hl-2">&#39;lastNameCanonical&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;firstNameCanonical&#39;</span><span class="hl-1">] </span><span class="hl-5">as</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1">,</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-6">propertyTranscodes:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">userId:</span><span class="hl-1"> </span><span class="hl-2">&#39;string&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">created:</span><span class="hl-1"> </span><span class="hl-2">&#39;timestamp&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">updated:</span><span class="hl-1"> </span><span class="hl-2">&#39;timestamp&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">firstNameCanonical:</span><span class="hl-1"> </span><span class="hl-2">&#39;string&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">lastNameCanonical:</span><span class="hl-1"> </span><span class="hl-2">&#39;string&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-6">indexes:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">created:</span><span class="hl-1"> { </span><span class="hl-6">hashKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;hashKey2&#39;</span><span class="hl-1">, </span><span class="hl-6">rangeKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;created&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">    </span><span class="hl-6">userCreated:</span><span class="hl-1"> { </span><span class="hl-6">hashKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;userPK&#39;</span><span class="hl-1">, </span><span class="hl-6">rangeKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;created&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">    </span><span class="hl-6">firstName:</span><span class="hl-1"> { </span><span class="hl-6">hashKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;hashKey2&#39;</span><span class="hl-1">, </span><span class="hl-6">rangeKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;firstNameRK&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">    </span><span class="hl-6">lastName:</span><span class="hl-1"> { </span><span class="hl-6">hashKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;hashKey2&#39;</span><span class="hl-1">, </span><span class="hl-6">rangeKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;lastNameRK&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">  } </span><span class="hl-5">as</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">entities:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">user:</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-6">uniqueProperty:</span><span class="hl-1"> </span><span class="hl-2">&#39;userId&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-6">timestampProperty:</span><span class="hl-1"> </span><span class="hl-2">&#39;created&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-6">shardBumps:</span><span class="hl-1"> [{ </span><span class="hl-6">timestamp:</span><span class="hl-1"> </span><span class="hl-6">Date</span><span class="hl-1">.</span><span class="hl-0">now</span><span class="hl-1">(), </span><span class="hl-6">charBits:</span><span class="hl-1"> </span><span class="hl-8">2</span><span class="hl-1">, </span><span class="hl-6">chars:</span><span class="hl-1"> </span><span class="hl-8">1</span><span class="hl-1"> }],</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-6">entitiesSchema:</span><span class="hl-1"> { </span><span class="hl-6">user:</span><span class="hl-1"> </span><span class="hl-6">userSchema</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-6">transcodes:</span><span class="hl-1"> </span><span class="hl-6">defaultTranscodes</span><span class="hl-1">,</span><br/><span class="hl-1">} </span><span class="hl-5">as</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// 3) Create the manager — types captured from values, shapes from schemas</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">manager</span><span class="hl-1"> = </span><span class="hl-0">createEntityManager</span><span class="hl-1">(</span><span class="hl-6">config</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<h3 id="tokenaware-helpers" class="tsd-anchor-link">Token‑aware helpers<a href="#tokenaware-helpers" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="ts"><span class="hl-3">// Input item (no generated keys yet)</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">user</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-6">userId:</span><span class="hl-1"> </span><span class="hl-2">&#39;u1&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">created:</span><span class="hl-1"> </span><span class="hl-6">Date</span><span class="hl-1">.</span><span class="hl-0">now</span><span class="hl-1">(),</span><br/><span class="hl-1">  </span><span class="hl-6">firstNameCanonical:</span><span class="hl-1"> </span><span class="hl-2">&#39;lee&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">lastNameCanonical:</span><span class="hl-1"> </span><span class="hl-2">&#39;zhang&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-3">// Add generated keys (hashKey/rangeKey + index tokens)</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">record</span><span class="hl-1"> = </span><span class="hl-6">manager</span><span class="hl-1">.</span><span class="hl-0">addKeys</span><span class="hl-1">(</span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">, </span><span class="hl-6">user</span><span class="hl-1">);</span><br/><br/><span class="hl-3">// Compute one or more primary keys</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">keys</span><span class="hl-1"> = </span><span class="hl-6">manager</span><span class="hl-1">.</span><span class="hl-0">getPrimaryKey</span><span class="hl-1">(</span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">, { </span><span class="hl-6">userId:</span><span class="hl-1"> </span><span class="hl-2">&#39;u1&#39;</span><span class="hl-1"> });</span><br/><br/><span class="hl-3">// Strip generated keys after read</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">item</span><span class="hl-1"> = </span><span class="hl-6">manager</span><span class="hl-1">.</span><span class="hl-0">removeKeys</span><span class="hl-1">(</span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">, </span><span class="hl-6">record</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>Types narrow automatically from the entity token (<code>'user'</code>). No casts required.</p>
<h2 id="indexaware-querying-cf-channel" class="tsd-anchor-link">Index‑aware querying (CF channel)<a href="#indexaware-querying-cf-channel" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>When you author a values‑first config literal with <code>indexes</code> (prefer <code>as const</code>), Entity Manager can:</p>
<ul>
<li>Constrain <code>shardQueryMap</code> keys to the index key union.</li>
<li>Narrow page‑key shapes per index (only its component tokens).</li>
<li>Derive ITS (index token subset) automatically from CF via <code>QueryOptionsByCF</code> and <code>ShardQueryMapByCF</code>.</li>
</ul>
<pre><code class="ts"><span class="hl-5">import</span><span class="hl-1"> </span><span class="hl-5">type</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">ShardQueryFunction</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">ShardQueryMapByCF</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">QueryOptionsByCF</span><span class="hl-1">,</span><br/><span class="hl-1">} </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-manager&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// CF: capture index tokens from a values-first literal</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">cf</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-6">indexes:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">firstName:</span><span class="hl-1"> { </span><span class="hl-6">hashKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;hashKey2&#39;</span><span class="hl-1">, </span><span class="hl-6">rangeKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;firstNameRK&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">    </span><span class="hl-6">lastName:</span><span class="hl-1"> { </span><span class="hl-6">hashKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;hashKey2&#39;</span><span class="hl-1">, </span><span class="hl-6">rangeKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;lastNameRK&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">} </span><span class="hl-5">as</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1">;</span><br/><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-9">CF</span><span class="hl-1"> = </span><span class="hl-4">typeof</span><span class="hl-1"> </span><span class="hl-6">cf</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// SQFs are typed; pageKey is narrowed to index components per IT</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">firstNameSQF</span><span class="hl-1">: </span><span class="hl-9">ShardQueryFunction</span><span class="hl-1">&lt;</span><br/><span class="hl-1">  </span><span class="hl-9">MyConfigMap</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">&#39;firstName&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-9">CF</span><br/><span class="hl-1">&gt; = </span><span class="hl-4">async</span><span class="hl-1"> (</span><span class="hl-6">hashKey</span><span class="hl-1">, </span><span class="hl-6">pageKey</span><span class="hl-1">, </span><span class="hl-6">pageSize</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><span class="hl-1"> ({ </span><span class="hl-6">count:</span><span class="hl-1"> </span><span class="hl-8">0</span><span class="hl-1">, </span><span class="hl-6">items:</span><span class="hl-1"> [], </span><span class="hl-6">pageKey</span><span class="hl-1"> });</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">lastNameSQF</span><span class="hl-1">: </span><span class="hl-9">ShardQueryFunction</span><span class="hl-1">&lt;</span><br/><span class="hl-1">  </span><span class="hl-9">MyConfigMap</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">&#39;lastName&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-9">CF</span><br/><span class="hl-1">&gt; = </span><span class="hl-4">async</span><span class="hl-1"> (</span><span class="hl-6">hashKey</span><span class="hl-1">, </span><span class="hl-6">pageKey</span><span class="hl-1">, </span><span class="hl-6">pageSize</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><span class="hl-1"> ({ </span><span class="hl-6">count:</span><span class="hl-1"> </span><span class="hl-8">0</span><span class="hl-1">, </span><span class="hl-6">items:</span><span class="hl-1"> [], </span><span class="hl-6">pageKey</span><span class="hl-1"> });</span><br/><br/><span class="hl-3">// CF-aware shardQueryMap — only &#39;firstName&#39; | &#39;lastName&#39; allowed</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">shardQueryMap</span><span class="hl-1">: </span><span class="hl-9">ShardQueryMapByCF</span><span class="hl-1">&lt;</span><span class="hl-9">MyConfigMap</span><span class="hl-1">, </span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">, </span><span class="hl-9">CF</span><span class="hl-1">&gt; = {</span><br/><span class="hl-1">  </span><span class="hl-6">firstName:</span><span class="hl-1"> </span><span class="hl-6">firstNameSQF</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">lastName:</span><span class="hl-1"> </span><span class="hl-6">lastNameSQF</span><span class="hl-1">,</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-3">// Derive ITS from CF for options</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">options</span><span class="hl-1">: </span><span class="hl-9">QueryOptionsByCF</span><span class="hl-1">&lt;</span><span class="hl-9">MyConfigMap</span><span class="hl-1">, </span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">, </span><span class="hl-9">CF</span><span class="hl-1">&gt; = {</span><br/><span class="hl-1">  </span><span class="hl-6">entityToken:</span><span class="hl-1"> </span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">item:</span><span class="hl-1"> {},</span><br/><span class="hl-1">  </span><span class="hl-6">shardQueryMap</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">limit:</span><span class="hl-1"> </span><span class="hl-8">50</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">pageSize:</span><span class="hl-1"> </span><span class="hl-8">10</span><span class="hl-1">,</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">result</span><span class="hl-1"> = </span><span class="hl-5">await</span><span class="hl-1"> </span><span class="hl-6">manager</span><span class="hl-1">.</span><span class="hl-0">query</span><span class="hl-1">(</span><span class="hl-6">options</span><span class="hl-1">);</span><br/><span class="hl-3">// result.pageKeyMap is a compact string — pass it to the next call’s options.pageKeyMap</span>
</code><button type="button">Copy</button></pre>

<h3 id="cc-based-aliases" class="tsd-anchor-link">CC-based aliases<a href="#cc-based-aliases" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>You can also derive ITS (index token subset) directly from a values‑first captured config type (CC) using <code>QueryOptionsByCC</code> and <code>ShardQueryMapByCC</code>. This mirrors the CF helpers but drives ITS from the CC type (via <code>IndexTokensFrom</code>) and passes the same CC through the CF channel for page‑key narrowing.</p>
<pre><code class="ts"><span class="hl-5">import</span><span class="hl-1"> </span><span class="hl-5">type</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">ShardQueryFunction</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">ShardQueryMapByCC</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">QueryOptionsByCC</span><span class="hl-1">,</span><br/><span class="hl-1">} </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-manager&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// A values-first config literal capturing index tokens (the same shape used for CF)</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">cc</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-6">indexes:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">firstName:</span><span class="hl-1"> { </span><span class="hl-6">hashKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;hashKey2&#39;</span><span class="hl-1">, </span><span class="hl-6">rangeKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;firstNameRK&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">    </span><span class="hl-6">lastName:</span><span class="hl-1"> { </span><span class="hl-6">hashKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;hashKey2&#39;</span><span class="hl-1">, </span><span class="hl-6">rangeKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;lastNameRK&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">} </span><span class="hl-5">as</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1">;</span><br/><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-9">CC</span><span class="hl-1"> = </span><span class="hl-4">typeof</span><span class="hl-1"> </span><span class="hl-6">cc</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// Reuse typed SQFs (pageKey narrowed per index)</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">firstNameSQF</span><span class="hl-1">: </span><span class="hl-9">ShardQueryFunction</span><span class="hl-1">&lt;</span><br/><span class="hl-1">  </span><span class="hl-9">MyConfigMap</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">&#39;firstName&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-9">CC</span><br/><span class="hl-1">&gt; = </span><span class="hl-4">async</span><span class="hl-1"> (</span><span class="hl-6">hashKey</span><span class="hl-1">, </span><span class="hl-6">pageKey</span><span class="hl-1">, </span><span class="hl-6">pageSize</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><span class="hl-1"> ({ </span><span class="hl-6">count:</span><span class="hl-1"> </span><span class="hl-8">0</span><span class="hl-1">, </span><span class="hl-6">items:</span><span class="hl-1"> [], </span><span class="hl-6">pageKey</span><span class="hl-1"> });</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">lastNameSQF</span><span class="hl-1">: </span><span class="hl-9">ShardQueryFunction</span><span class="hl-1">&lt;</span><br/><span class="hl-1">  </span><span class="hl-9">MyConfigMap</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">&#39;lastName&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-9">CC</span><br/><span class="hl-1">&gt; = </span><span class="hl-4">async</span><span class="hl-1"> (</span><span class="hl-6">hashKey</span><span class="hl-1">, </span><span class="hl-6">pageKey</span><span class="hl-1">, </span><span class="hl-6">pageSize</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><span class="hl-1"> ({ </span><span class="hl-6">count:</span><span class="hl-1"> </span><span class="hl-8">0</span><span class="hl-1">, </span><span class="hl-6">items:</span><span class="hl-1"> [], </span><span class="hl-6">pageKey</span><span class="hl-1"> });</span><br/><br/><span class="hl-3">// CC-aware shardQueryMap — only &#39;firstName&#39; | &#39;lastName&#39; allowed</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">shardQueryMapCC</span><span class="hl-1">: </span><span class="hl-9">ShardQueryMapByCC</span><span class="hl-1">&lt;</span><span class="hl-9">MyConfigMap</span><span class="hl-1">, </span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">, </span><span class="hl-9">CC</span><span class="hl-1">&gt; = {</span><br/><span class="hl-1">  </span><span class="hl-6">firstName:</span><span class="hl-1"> </span><span class="hl-6">firstNameSQF</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">lastName:</span><span class="hl-1"> </span><span class="hl-6">lastNameSQF</span><span class="hl-1">,</span><br/><span class="hl-1">};</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">optionsCC</span><span class="hl-1">: </span><span class="hl-9">QueryOptionsByCC</span><span class="hl-1">&lt;</span><span class="hl-9">MyConfigMap</span><span class="hl-1">, </span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">, </span><span class="hl-9">CC</span><span class="hl-1">&gt; = {</span><br/><span class="hl-1">  </span><span class="hl-6">entityToken:</span><span class="hl-1"> </span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">item:</span><span class="hl-1"> {},</span><br/><span class="hl-1">  </span><span class="hl-6">shardQueryMap:</span><span class="hl-1"> </span><span class="hl-6">shardQueryMapCC</span><span class="hl-1">,</span><br/><span class="hl-1">};</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">resultCC</span><span class="hl-1"> = </span><span class="hl-5">await</span><span class="hl-1"> </span><span class="hl-6">manager</span><span class="hl-1">.</span><span class="hl-0">query</span><span class="hl-1">(</span><span class="hl-6">optionsCC</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>Notes:</p>
<ul>
<li>Entity Manager enumerates hash‑key space for the time window, rehydrates page keys (when present), executes shard queries in parallel (throttled), dedupes by unique property, sorts, and dehydrates a new pageKeyMap.</li>
<li>For provider integration, the SQF lambda encapsulates the platform‑specific query for one index + shard page. See tests and entity‑client‑dynamodb for examples.</li>
</ul>
<h2 id="projectionaware-typing-k" class="tsd-anchor-link">Projection‑aware typing (K)<a href="#projectionaware-typing-k" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Entity Manager supports a type‑only projection channel K that narrows result item shapes when a provider adapter projects a subset of attributes at runtime. Pass your attributes as a const tuple and thread K through <code>ShardQueryFunction/Map</code>, <code>QueryOptions</code>, and <code>QueryResult</code>.</p>
<pre><code class="ts"><span class="hl-5">import</span><span class="hl-1"> </span><span class="hl-5">type</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">ConfigMap</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">EntityItemByToken</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">QueryOptions</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">QueryResult</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">ShardQueryFunction</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">ShardQueryMap</span><span class="hl-1">,</span><br/><span class="hl-1">} </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-manager&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// Minimal entities (example)</span><br/><span class="hl-4">interface</span><span class="hl-1"> </span><span class="hl-9">Email</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">created</span><span class="hl-1">: </span><span class="hl-9">number</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-6">email</span><span class="hl-1">: </span><span class="hl-9">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-6">userId</span><span class="hl-1">: </span><span class="hl-9">string</span><span class="hl-1">;</span><br/><span class="hl-1">}</span><br/><span class="hl-4">interface</span><span class="hl-1"> </span><span class="hl-9">User</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">beneficiaryId</span><span class="hl-1">: </span><span class="hl-9">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-6">created</span><span class="hl-1">: </span><span class="hl-9">number</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-6">firstNameCanonical</span><span class="hl-1">: </span><span class="hl-9">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-6">lastNameCanonical</span><span class="hl-1">: </span><span class="hl-9">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-6">phone</span><span class="hl-1">?: </span><span class="hl-9">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-6">updated</span><span class="hl-1">: </span><span class="hl-9">number</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-6">userId</span><span class="hl-1">: </span><span class="hl-9">string</span><span class="hl-1">;</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-9">MyConfigMap</span><span class="hl-1"> = </span><span class="hl-9">ConfigMap</span><span class="hl-1">&lt;{</span><br/><span class="hl-1">  </span><span class="hl-6">EntityMap</span><span class="hl-1">: { </span><span class="hl-6">email</span><span class="hl-1">: </span><span class="hl-9">Email</span><span class="hl-1">; </span><span class="hl-6">user</span><span class="hl-1">: </span><span class="hl-9">User</span><span class="hl-1"> };</span><br/><span class="hl-1">  </span><span class="hl-6">HashKey</span><span class="hl-1">: </span><span class="hl-2">&#39;hashKey2&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-6">RangeKey</span><span class="hl-1">: </span><span class="hl-2">&#39;rangeKey&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-6">ShardedKeys</span><span class="hl-1">: </span><span class="hl-2">&#39;beneficiaryPK&#39;</span><span class="hl-1"> | </span><span class="hl-2">&#39;userPK&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-6">UnshardedKeys</span><span class="hl-1">: </span><span class="hl-2">&#39;firstNameRK&#39;</span><span class="hl-1"> | </span><span class="hl-2">&#39;lastNameRK&#39;</span><span class="hl-1"> | </span><span class="hl-2">&#39;phoneRK&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-6">TranscodedProperties</span><span class="hl-1">:</span><br/><span class="hl-1">    | </span><span class="hl-2">&#39;beneficiaryId&#39;</span><br/><span class="hl-1">    | </span><span class="hl-2">&#39;created&#39;</span><br/><span class="hl-1">    | </span><span class="hl-2">&#39;email&#39;</span><br/><span class="hl-1">    | </span><span class="hl-2">&#39;firstNameCanonical&#39;</span><br/><span class="hl-1">    | </span><span class="hl-2">&#39;lastNameCanonical&#39;</span><br/><span class="hl-1">    | </span><span class="hl-2">&#39;phone&#39;</span><br/><span class="hl-1">    | </span><span class="hl-2">&#39;updated&#39;</span><br/><span class="hl-1">    | </span><span class="hl-2">&#39;userId&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">}&gt;;</span><br/><br/><span class="hl-3">// CF capturing a single index</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">cf</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-6">indexes:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">firstName:</span><span class="hl-1"> { </span><span class="hl-6">hashKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;hashKey2&#39;</span><span class="hl-1">, </span><span class="hl-6">rangeKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;firstNameRK&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">} </span><span class="hl-5">as</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1">;</span><br/><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-9">CF</span><span class="hl-1"> = </span><span class="hl-4">typeof</span><span class="hl-1"> </span><span class="hl-6">cf</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// Projection attributes as const tuple — narrows K.</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">attrs</span><span class="hl-1"> = [</span><span class="hl-2">&#39;userId&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;created&#39;</span><span class="hl-1">] </span><span class="hl-5">as</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1">;</span><br/><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-9">K</span><span class="hl-1"> = </span><span class="hl-4">typeof</span><span class="hl-1"> </span><span class="hl-6">attrs</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// A typed SQF: pageKey narrows via CF; items narrow via K (type-only).</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-0">sqf</span><span class="hl-1">: </span><span class="hl-9">ShardQueryFunction</span><span class="hl-1">&lt;</span><span class="hl-9">MyConfigMap</span><span class="hl-1">, </span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;firstName&#39;</span><span class="hl-1">, </span><span class="hl-9">CF</span><span class="hl-1">, </span><span class="hl-9">K</span><span class="hl-1">&gt; = </span><span class="hl-4">async</span><span class="hl-1"> (</span><br/><span class="hl-1">  </span><span class="hl-6">_hashKey</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">_pageKey</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">_pageSize</span><span class="hl-1">,</span><br/><span class="hl-1">) </span><span class="hl-4">=&gt;</span><span class="hl-1"> ({</span><br/><span class="hl-1">  </span><span class="hl-6">count:</span><span class="hl-1"> </span><span class="hl-8">0</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">items:</span><span class="hl-1"> [], </span><span class="hl-3">// never[] is assignable to the projected array</span><br/><span class="hl-1">  </span><span class="hl-6">pageKey:</span><span class="hl-1"> </span><span class="hl-6">_pageKey</span><span class="hl-1">,</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-3">// ShardQueryMap carrying CF and K.</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">map</span><span class="hl-1">: </span><span class="hl-9">ShardQueryMap</span><span class="hl-1">&lt;</span><span class="hl-9">MyConfigMap</span><span class="hl-1">, </span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;firstName&#39;</span><span class="hl-1">, </span><span class="hl-9">CF</span><span class="hl-1">, </span><span class="hl-9">K</span><span class="hl-1">&gt; = {</span><br/><span class="hl-1">  </span><span class="hl-6">firstName:</span><span class="hl-1"> </span><span class="hl-6">sqf</span><span class="hl-1">,</span><br/><span class="hl-1">};</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">options</span><span class="hl-1">: </span><span class="hl-9">QueryOptions</span><span class="hl-1">&lt;</span><span class="hl-9">MyConfigMap</span><span class="hl-1">, </span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;firstName&#39;</span><span class="hl-1">, </span><span class="hl-9">CF</span><span class="hl-1">, </span><span class="hl-9">K</span><span class="hl-1">&gt; = {</span><br/><span class="hl-1">  </span><span class="hl-6">entityToken:</span><span class="hl-1"> </span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">item:</span><span class="hl-1"> {},</span><br/><span class="hl-1">  </span><span class="hl-6">shardQueryMap:</span><span class="hl-1"> </span><span class="hl-6">map</span><span class="hl-1">,</span><br/><span class="hl-1">};</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">result</span><span class="hl-1">: </span><span class="hl-9">QueryResult</span><span class="hl-1">&lt;</span><span class="hl-9">MyConfigMap</span><span class="hl-1">, </span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;firstName&#39;</span><span class="hl-1">, </span><span class="hl-9">K</span><span class="hl-1">&gt; =</span><br/><span class="hl-1">  </span><span class="hl-5">await</span><span class="hl-1"> </span><span class="hl-6">manager</span><span class="hl-1">.</span><span class="hl-0">query</span><span class="hl-1">(</span><span class="hl-6">options</span><span class="hl-1">);</span><br/><span class="hl-3">// result.items: Pick&lt;EntityItemByToken&lt;MyConfigMap, &#39;user&#39;&gt;, &#39;userId&#39; | &#39;created&#39;&gt;[]</span>
</code><button type="button">Copy</button></pre>

<p>Notes:</p>
<ul>
<li>K is a type‑only channel; it does not change runtime behavior. Providers (e.g., DynamoDB adapters) execute projections.</li>
<li>Dedupe/sort invariants: Entity Manager dedupes by <code>uniqueProperty</code> and applies <code>QueryOptions.sortOrder</code>. If your adapter projects attributes, ensure it auto‑includes <code>uniqueProperty</code> and any explicit sort keys when callers omit them from K.</li>
</ul>
<h2 id="page-keys-in-a-nutshell" class="tsd-anchor-link">Page keys in a nutshell<a href="#page-keys-in-a-nutshell" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li><code>rehydratePageKeyMap</code> decodes a dehydrated array (compressed string) into a two‑layer map of <code>{ indexToken: { hashKeyValue: pageKey | undefined } }</code>.</li>
<li><code>dehydratePageKeyMap</code> performs the inverse and emits a compact array (compressed in <code>query()</code>).</li>
<li>You rarely call these directly — <code>query()</code> composes them for you — but the API is exposed for advanced flows.</li>
</ul>
<h2 id="esm-cjs" class="tsd-anchor-link">ESM / CJS<a href="#esm-cjs" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><pre><code class="ts"><span class="hl-3">// ESM</span><br/><span class="hl-5">import</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">createEntityManager</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">defaultTranscodes</span><span class="hl-1">,</span><br/><span class="hl-1">} </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-manager&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// CJS</span><br/><span class="hl-4">const</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">createEntityManager</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-7">defaultTranscodes</span><span class="hl-1">,</span><br/><span class="hl-1">} = </span><span class="hl-0">require</span><span class="hl-1">(</span><span class="hl-2">&#39;@karmaniverous/entity-manager&#39;</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<h2 id="logging" class="tsd-anchor-link">Logging<a href="#logging" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Entity Manager logs debug and error details via the injected logger (defaults to <code>console</code>).</p>
<pre><code class="ts"><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">logger</span><span class="hl-1"> = { </span><span class="hl-0">debug</span><span class="hl-6">:</span><span class="hl-1"> () </span><span class="hl-4">=&gt;</span><span class="hl-1"> </span><span class="hl-4">undefined</span><span class="hl-1">, </span><span class="hl-6">error:</span><span class="hl-1"> </span><span class="hl-6">console</span><span class="hl-1">.</span><span class="hl-6">error</span><span class="hl-1"> };</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">manager</span><span class="hl-1"> = </span><span class="hl-0">createEntityManager</span><span class="hl-1">(</span><span class="hl-6">config</span><span class="hl-1">, </span><span class="hl-6">logger</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<h2 id="types-youll-reach-for" class="tsd-anchor-link">Types you’ll reach for<a href="#types-youll-reach-for" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>Values/schema capture
<ul>
<li><code>createEntityManager(config, logger?)</code></li>
<li><code>ConfigInput</code> (values‑first), <code>CapturedConfigMapFrom</code>, <code>EntitiesFromSchema</code></li>
</ul>
</li>
<li>Token aware
<ul>
<li><code>EntityToken&lt;CC&gt;</code>, <code>EntityItemByToken&lt;CC, ET&gt;</code>, <code>EntityRecordByToken&lt;CC, ET&gt;</code></li>
</ul>
</li>
<li>Index aware (CF channel)
<ul>
<li><code>PageKeyByIndex&lt;CC, ET, IT, CF&gt;</code></li>
<li><code>ShardQueryFunction&lt;CC, ET, IT, CF&gt;</code>, <code>ShardQueryMap&lt;CC, ET, ITS, CF&gt;</code></li>
<li><code>QueryOptions&lt;CC, ET, ITS, CF&gt;</code>, <code>QueryResult&lt;CC, ET, ITS&gt;</code></li>
<li>DX sugar: <code>IndexTokensOf&lt;CF&gt;</code>, <code>QueryOptionsByCF</code>, <code>ShardQueryMapByCF</code>, <code>IndexTokensFrom&lt;CC&gt;</code>, <code>QueryOptionsByCC</code>, <code>ShardQueryMapByCC</code></li>
</ul>
</li>
<li>Projection helpers
<ul>
<li><code>KeysFrom&lt;K&gt;</code></li>
<li><code>Projected&lt;T, K&gt;</code></li>
<li><code>ProjectedItemByToken&lt;CC, ET, K&gt;</code></li>
</ul>
</li>
</ul>
<p>See the full API: <a href="https://docs.karmanivero.us/entity-manager">https://docs.karmanivero.us/entity-manager</a></p>
<h2 id="scripts-repo" class="tsd-anchor-link">Scripts (repo)<a href="#scripts-repo" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>build: rollup outputs ESM/CJS + .d.ts</li>
<li>test: vitest with coverage</li>
<li>lint: ESLint (type‑aware) + Prettier</li>
<li>docs: TypeDoc</li>
<li>typecheck: tsc + tsd (type‑level tests)</li>
</ul>
<h2 id="license" class="tsd-anchor-link">License<a href="#license" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>BSD‑3‑Clause (see package.json).</p>
<hr>
<p>Built for you with ❤️ on Bali! Find more great tools &amp; templates on <a href="https://github.com/karmaniverous" target="_blank" class="external">my GitHub Profile</a>.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#entity-manager"><span>entity-<wbr/>manager</span></a><ul><li><a href="#why-this-library"><span>Why this library?</span></a></li><li><a href="#install"><span>Install</span></a></li><li><a href="#dx-highlights"><span>DX highlights</span></a></li><li><a href="#quick-start-valuesfirst-schemafirst"><span>Quick start (values‑first + schema‑first)</span></a></li><li><ul><li><a href="#tokenaware-helpers"><span>Token‑aware helpers</span></a></li></ul></li><li><a href="#indexaware-querying-cf-channel"><span>Index‑aware querying (<wbr/>CF channel)</span></a></li><li><ul><li><a href="#cc-based-aliases"><span>CC-<wbr/>based aliases</span></a></li></ul></li><li><a href="#projectionaware-typing-k"><span>Projection‑aware typing (<wbr/>K)</span></a></li><li><a href="#page-keys-in-a-nutshell"><span>Page keys in a nutshell</span></a></li><li><a href="#esm-cjs"><span>ESM / <wbr/>CJS</span></a></li><li><a href="#logging"><span>Logging</span></a></li><li><a href="#types-youll-reach-for"><span>Types you’ll reach for</span></a></li><li><a href="#scripts-repo"><span>Scripts (repo)</span></a></li><li><a href="#license"><span>License</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="modules.html">@karmaniverous/entity-manager</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
